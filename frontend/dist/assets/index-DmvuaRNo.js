import{c as w}from"./navbars-F_vH8I19.js";import{g as x,s as b}from"./index-CA-6fEX3.js";import{s as i}from"./notification--NRigmGR.js";async function y(e){const n=await fetch("/api/user/me",{headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error("Failed to fetch user data");const{user:a}=await n.json(),t=await fetch("/api/user/friends",{headers:{Authorization:`Bearer ${e}`}}),{friends:o}=await t.json();if(!t.ok)throw new Error("Failed to fetch friends");const r=await fetch("/api/user/history",{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error("Failed to fetch match history");const{history:s}=await r.json();return{user:a,friends:o,history:s}}function v(e,n){const a=document.createElement("div");a.className="flex flex-col items-center gap-4";const t=document.createElement("p");return t.innerHTML=E(e,n),t.className="text-lg font-bold ml-8",a.appendChild(t),a}function E(e,n){return`
        <span class="text-green-400">Wins: ${e}</span> |
        <span class="text-red-400">Losses: ${n}</span>
    `}function C(){const e=document.createElement("div");e.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50";const n=document.createElement("div");n.className="bg-white p-6 rounded-lg shadow-lg w-96 flex flex-col gap-4";const a=document.createElement("h2");a.className="text-xl font-bold text-gray-700";const t=document.createElement("input");t.type="text",t.placeholder="Enter 2FA Code",t.className="w-full p-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black";const o=document.createElement("img");o.className="w-full h-auto rounded";const r=document.createElement("button");r.textContent="Submit",r.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded";const s=document.createElement("button");return s.textContent="Cancel",s.className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded",n.append(a,t,r,s),e.appendChild(n),e.classList.add("hidden"),document.body.appendChild(e),{modal:e,title:a,input:t,verifyButton:r,cancelButton:s,qrImage:o}}function f(e,n){e.classList.toggle("hidden",!n)}async function N(e,n){if(!(await fetch("/api/2fa/off",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({code:n})})).ok)throw new Error("Failed to disable 2FA")}async function k(e){const n=await fetch("/api/2fa/on",{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error("Failed to generate 2FA setup");return(await n.json()).qr}async function A(e,n){if(!(await fetch("/api/2fa/on",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({code:n})})).ok)throw new Error("Failed to enable 2FA")}function F(){const e=document.createElement("div");e.className="flex flex-col items-center gap-4";const n=x("2fa")==="true",a=document.createElement("p");a.textContent=`2FA is currently ${n?"Enabled":"Disabled"}`,a.className="text-lg font-bold ml-8";const t=document.createElement("button");t.textContent=n?"Disable 2FA":"Enable 2FA",t.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-8";const{modal:o,title:r,input:s,verifyButton:c,cancelButton:l,qrImage:d}=C();return t.addEventListener("click",async()=>{const m=sessionStorage.getItem("token");if(!m)return i("No token found","error");try{if(n)r.textContent="Disable 2FA",d.style.display="none",f(o,!0),c.onclick=async()=>{const u=s.value.trim();if(!u)return i("Enter 2FA code","error");await N(m,u),b("2fa","false"),i("2FA disabled successfully!","success"),f(o,!1),window.location.reload()};else{const u=await k(m);r.textContent="Enable 2FA",d.src=u,d.style.display="block",o.querySelector("div").insertBefore(d,s),f(o,!0),c.onclick=async()=>{const p=s.value.trim();if(!p)return i("Enter authenticator code","error");await A(m,p),b("2fa","true"),i("2FA enabled successfully!","success"),f(o,!1),window.location.reload()}}}catch{i("Error toggling 2FA","error")}}),l.addEventListener("click",()=>{f(o,!1)}),e.append(a,t,o),e}function S(e){return e.size>3*1024*1024?"File size must not exceed 3 MB.":e.type.startsWith("image/")?null:"Invalid file type. Please upload an image."}async function L(e,n){const a=new FormData;a.append("avatar",e,e.name);const t=await fetch("/api/user/avatar",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:a});if(!t.ok)throw new Error("Failed to upload avatar");const{avatarUrl:o}=await t.json();return o}async function $(e,n){if(n.startsWith("/avatars/")){if(!(await fetch("/api/user/avatar",{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Failed to delete avatar")}else throw new Error("Cannot delete default avatar")}function B(e){const n=document.createElement("div");n.className="flex flex-col items-center gap-4";const a=document.createElement("img");a.src=e,a.alt="Avatar",a.className="w-32 h-32 rounded-full shadow-lg border-4 border-gray-300 ml-8";const t=document.createElement("div");t.className="flex items-center gap-4";const o=document.createElement("button");o.textContent="Upload Avatar",o.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-8";const r=document.createElement("button");r.textContent="X",r.className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded";const s=document.createElement("input");return s.type="file",s.accept="image/*",s.className="hidden",o.addEventListener("click",()=>{s.click()}),s.addEventListener("change",async c=>{var m;const l=(m=c.target.files)==null?void 0:m[0];if(!l)return;const d=S(l);if(d){i(d,"error");return}try{const u=sessionStorage.getItem("token");if(!u)throw new Error("No token found");i("Uploading avatar...","info");const p=await L(l,u);a.src=p,i("Avatar uploaded successfully!","success"),window.location.reload()}catch(u){i(`Failed to upload avatar. ${u.message}`,"error")}}),r.addEventListener("click",async()=>{try{const c=sessionStorage.getItem("token");if(!c)throw new Error("No token found");i("Deleting avatar...","info"),await $(c,e),a.src="",i("Avatar deleted successfully!","success"),window.location.reload()}catch(c){i(`${c.message}. Please try again.`,"error")}}),t.append(o,r),n.append(a,t,s),n}function T(e,n,a){const t=document.createElement("div");t.className="flex flex-col items-center gap-4 min-w-[135px]";const o=document.createElement("img");o.src=a,o.alt=`${e}'s avatar`,o.className="w-28 h-28 rounded-full border-2",o.style.borderColor=n?"green":"darkred";const r=document.createElement("span");return r.textContent=e,r.className=`text-sm font-medium ${n?"text-green-500":"text-red-700"}`,t.appendChild(o),t.appendChild(r),t}function I(){const e=document.createElement("div");e.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50";const n=document.createElement("div");n.className="bg-white p-6 rounded-lg shadow-lg w-96 flex flex-col gap-4";const a=document.createElement("h2");a.textContent="Add Friend",a.className="text-xl font-bold text-gray-700";const t=document.createElement("input");t.type="text",t.placeholder="Enter Friend ID",t.className="w-full p-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black";const o=document.createElement("button");o.textContent="Add",o.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded",o.addEventListener("click",async()=>{const s=x("token");if(!s){i("You need to be logged in to add friends.","error");return}const c=t.value.trim();if(!c){i("Please enter a valid Friend ID.","error");return}try{const l=await fetch(`/api/user/friends/${c}`,{method:"POST",headers:{Authorization:`Bearer ${s}`}});if(!l.ok){const d=await l.json();throw new Error(d.error||"Failed to add friend.")}i("Friend added successfully!","success"),e.classList.add("hidden"),window.location.reload()}catch(l){i(`Error: ${l.message}`,"error")}});const r=document.createElement("button");return r.textContent="Cancel",r.className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded",r.addEventListener("click",()=>{e.classList.add("hidden")}),n.append(a,t,o,r),e.appendChild(n),e}function U(e){const n=document.createElement("div");n.className="flex flex-col items-center gap-4";const a=document.createElement("h2");a.textContent="Friends",a.className="text-xl font-bold";const t=document.createElement("div");t.className="scroll-container flex gap-4 overflow-x-auto",e.sort((s,c)=>Number(c.isOnline)-Number(s.isOnline)).forEach(s=>{const c=T(s.username,s.isOnline,s.avatarUrl);t.appendChild(c)});const o=document.createElement("button");o.textContent="Add Friend",o.className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 mt-4";const r=I();return o.addEventListener("click",()=>{r.classList.remove("hidden")}),n.append(a,t,o,r),n}function z(e){const n=document.createElement("div");n.className="flex flex-col items-center gap-4";const a=document.createElement("h2");a.textContent="Match History",a.className="text-xl font-bold";const t=document.createElement("ul");return t.className="w-full",e.forEach(o=>{const r=D(o);t.appendChild(r)}),n.appendChild(a),n.appendChild(t),n}function D(e){const n=document.createElement("li"),a=e.result.toLowerCase()==="win"?"text-green-400":"text-red-400",t=new Date(e.playedAt).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});return n.innerHTML=`
    <span class="font-bold">${e.opponent}</span> -
    <span class="${a} font-semibold">${e.result}</span>
    <span class="text-gray-400">(${t})</span>
  `,n.className="p-2 rounded bg-gray-700 text-white",n}function j(e,n){const a=document.createElement("div");a.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50";const t=document.createElement("div");t.className="bg-white p-6 rounded-lg shadow-lg w-96 flex flex-col gap-4";const o=document.createElement("h2");o.textContent="Edit Username",o.className="text-xl font-bold text-gray-700";const r=document.createElement("input");r.type="text",r.value=e,r.className="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black";const s=document.createElement("button");s.textContent="Save",s.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded";const c=document.createElement("button");return c.textContent="Cancel",c.className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded",s.addEventListener("click",async()=>{const l=r.value.trim();if(!l){i("Username cannot be empty.","error");return}try{await n(l),a.classList.add("hidden")}catch{i("Failed to update username. Please try again.","error")}}),c.addEventListener("click",()=>{a.classList.add("hidden")}),t.appendChild(o),t.appendChild(r),t.appendChild(s),t.appendChild(c),a.appendChild(t),document.body.appendChild(a),a}async function M(e,n){const a=await fetch("/api/user/username",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({username:e})});if(!a.ok){const t=await a.json();throw new Error(t.error||"Failed to update username")}}async function P(e,n){if(e.startsWith("/avatars/"))return;if(!(await fetch("/api/user/avatar",{method:"PATCH",headers:{Authorization:`Bearer ${n}`},body:JSON.stringify({})})).ok)throw new Error("Failed to update avatar")}async function O(e,n,a){const t=sessionStorage.getItem("token");if(!t)throw new Error("No token found");await M(e,t),await P(n,t),a.textContent=`Username: ${e}`,i("Username updated successfully!","success"),window.location.reload()}function H(e,n,a){const t=document.createElement("div");t.className="flex flex-col items-center gap-4";const o=document.createElement("p");o.textContent=`Username: ${e}`,o.className="text-lg font-bold text-white-700 ml-8";const r=document.createElement("p");r.textContent=`ID: ${a}`,r.className="text-md text-white-500 ml-8";const s=document.createElement("button");s.textContent="Edit Username",s.className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-8";const c=j(e,async l=>{await O(l,n,o)});return s.addEventListener("click",()=>{c.classList.remove("hidden")}),t.appendChild(o),t.appendChild(r),t.appendChild(s),t}async function R(e){if(!e)return;e.innerHTML="";const n=document.createElement("div");n.className="min-h-screen flex flex-col md:flex-row gap-8 p-8 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-gray-800";try{const a=sessionStorage.getItem("token");if(!a)throw new Error("No token found");const{user:t,friends:o,history:r}=await y(a),s=B(t.avatarUrl),c=H(t.username,t.avatarUrl,t.id),l=v(t.wins,t.losses),d=F(),m=U(o),u=z(r),p=document.createElement("div");p.className="flex flex-col gap-8 w-full md:w-1/3 bg-black bg-opacity-55 p-10 rounded-lg shadow-2xl text-gray-100",p.append(s,c,l,d);const h=document.createElement("div");h.className="flex flex-col gap-8 w-full md:w-2/3 bg-black bg-opacity-50 p-10 rounded-lg shadow-2xl text-gray-100",h.append(m,u),n.append(p,h),n.style.userSelect="none",e.appendChild(n);const g=await w();g&&e.appendChild(g)}catch{e.innerHTML='<p class="text-red-500">Failed to load profile page. Please try again later.</p>',sessionStorage.clear()}}export{R as render};
